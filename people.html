<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>2DWORLD - People</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .panel {
      background:#f5f5f5;
      border:1px solid rgba(0,0,0,.35);
      border-top:none;
      box-shadow:0 10px 22px rgba(0,0,0,.25);
      padding:10px;
    }
    .bar {
      background:linear-gradient(#f7f7f7,#dfdfdf);
      border:1px solid #bdbdbd;
      padding:8px;
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
    }
    .bar b{ margin-right:6px; }
    .results {
      background:#fff;
      border:1px solid #b9b9b9;
      box-shadow:2px 2px 0 rgba(0,0,0,.20);
      padding:10px;
      min-height:440px;
    }
    .hint { color:#666; font-size:11px; margin-top:6px; }
    .pill {
      display:inline-block; padding:2px 6px;
      border:1px solid #bbb; background:linear-gradient(#fff,#ededed);
      font-size:10px; border-radius:999px; margin-left:6px;
    }

    /* cards */
    .userCard{
      display:flex; gap:10px; align-items:center;
      border:1px solid #cfcfcf;
      background:linear-gradient(#ffffff,#f3f3f3);
      box-shadow:2px 2px 0 rgba(0,0,0,.15);
      padding:8px;
      margin:8px 0;
    }
    .avatarSmall{
      width:48px; height:48px;
      border:1px solid #aaa;
      background:#fff;
      image-rendering: pixelated;
    }
    .userMeta .name{
      font-size:14px;
      font-weight:bold;
      margin-bottom:2px;
    }
    .userMeta .sub{
      font-size:11px;
      color:#444;
      margin-top:2px;
    }
    .mono{ font-family:monospace; }
  </style>
</head>

<body>
  <div id="viewport">
    <div id="page">

      <div class="top-sky">
        <div class="topbar">
          <div class="auth"><a href="account.html">Login</a></div>

          <a class="logo" href="index.html" aria-label="2DWORLD home">
            <span class="logo-word">2D</span><span class="logo-world">WORLD</span>
          </a>

          <a class="signup-cta" href="register.html">Sign-up and Play!</a>
        </div>

        <ul class="nav">
          <li><a href="index.html">My 2DWORLD</a></li>
          <li><a href="#" onclick="return false;">Worlds</a></li>
          <li><a href="#" onclick="return false;">Catalog</a></li>
          <li><a class="active" href="people.html">People</a></li>
          <li><a href="#" onclick="return false;">Creator Club</a></li>
          <li><a href="#" onclick="return false;">Events</a></li>
          <li><a href="#" onclick="return false;">Forum</a></li>
          <li><a href="#" onclick="return false;">News</a></li>
          <li><a href="#" onclick="return false;">Parents</a></li>
          <li><a href="#" onclick="return false;">Help</a></li>
        </ul>
      </div>

      <div class="panel">
        <div class="bar">
          <b>Search:</b>
          <input id="q" class="txt" type="text" placeholder="Search users..." autocomplete="off" />
          <button id="btnUsers" class="smallBtn" type="button">Search Users</button>
          <button class="smallBtn" type="button" disabled title="Coming soon">Search Worlds</button>
          <span id="status" class="pill" style="display:none;"></span>
        </div>

        <div class="results">
          <div id="empty" class="muted">
            Type a username and press <b>Search Users</b>.<br>
            <div class="hint">Tip: searching works best with the start of a name (example: <b>adm</b>).</div>
          </div>
          <div id="list"></div>
        </div>
      </div>

      <div class="footer">
        <div class="foot-links">
          <a href="#" onclick="return false;"><b>Privacy Policy</b></a> | <a href="#" onclick="return false;">Advertise</a> |
          <a href="#" onclick="return false;">Press</a> | <a href="#" onclick="return false;">Contact</a> |
          <a href="#" onclick="return false;">About</a> | <a href="#" onclick="return false;">Free Worlds</a> |
          <a href="#" onclick="return false;">Jobs</a>
        </div>
        <div class="legal">
          2DWORLD © <span id="y"></span>. This site is not affiliated with Roblox Corporation.<br>
          Use of this site signifies your acceptance of the Terms and Conditions.
        </div>
      </div>

    </div>
  </div>

  <script>document.getElementById("y").textContent = new Date().getFullYear();</script>

  <script type="module">
    import { db } from "./firebase.js";
    import {
      collection, getDocs, query, orderBy, startAt, endAt, limit, documentId
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // Pixel-ish SVG avatars (male/female)
    const MALE = "data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%2032%2032%22%20shape-rendering=%22crispEdges%22%3E%0A%3Crect%20width=%2232%22%20height=%2232%22%20fill=%22transparent%22/%3E%0A%3Crect%20x=%229%22%20y=%2229%22%20width=%2214%22%20height=%222%22%20fill=%22%23000%22%20opacity=%22.15%22/%3E%0A%3C!--%20hat%20--%3E%0A%3Crect%20x=%229%22%20y=%223%22%20width=%2214%22%20height=%224%22%20fill=%22%23d9493a%22/%3E%3Crect%20x=%228%22%20y=%227%22%20width=%2216%22%20height=%222%22%20fill=%22%23c13c2f%22/%3E%0A%3C!--%20face%20--%3E%0A%3Crect%20x=%2210%22%20y=%229%22%20width=%2212%22%20height=%2210%22%20fill=%22%23f2c39a%22/%3E%0A%3Crect%20x=%2211%22%20y=%2212%22%20width=%222%22%20height=%222%22%20fill=%22%232b2b2b%22/%3E%3Crect%20x=%2219%22%20y=%2212%22%20width=%222%22%20height=%222%22%20fill=%22%232b2b2b%22/%3E%0A%3Crect%20x=%2213%22%20y=%2216%22%20width=%226%22%20height=%221%22%20fill=%22%23c98a63%22/%3E%0A%3C!--%20shirt%20--%3E%0A%3Crect%20x=%229%22%20y=%2219%22%20width=%2214%22%20height=%227%22%20fill=%22%232b7bd4%22/%3E%0A%3Crect%20x=%226%22%20y=%2220%22%20width=%223%22%20height=%225%22%20fill=%22%23f2c39a%22/%3E%3Crect%20x=%2223%22%20y=%2220%22%20width=%223%22%20height=%225%22%20fill=%22%23f2c39a%22/%3E%0A%3C!--%20legs%20--%3E%0A%3Crect%20x=%2210%22%20y=%2226%22%20width=%225%22%20height=%223%22%20fill=%22%233b3b3b%22/%3E%3Crect%20x=%2217%22%20y=%2226%22%20width=%225%22%20height=%223%22%20fill=%22%233b3b3b%22/%3E%0A%3Crect%20x=%229%22%20y=%2229%22%20width=%227%22%20height=%222%22%20fill=%22%23111%22/%3E%3Crect%20x=%2216%22%20y=%2229%22%20width=%227%22%20height=%222%22%20fill=%22%23111%22/%3E%0A%3C/svg%3E";
    const FEMALE = "data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%2032%2032%22%20shape-rendering=%22crispEdges%22%3E%0A%3Crect%20width=%2232%22%20height=%2232%22%20fill=%22transparent%22/%3E%0A%3Crect%20x=%229%22%20y=%2229%22%20width=%2214%22%20height=%222%22%20fill=%22%23000%22%20opacity=%22.15%22/%3E%0A%3C!--%20hair%20--%3E%0A%3Crect%20x=%229%22%20y=%223%22%20width=%2214%22%20height=%225%22%20fill=%22%237a34c8%22/%3E%3Crect%20x=%228%22%20y=%228%22%20width=%2216%22%20height=%222%22%20fill=%22%23642aa6%22/%3E%0A%3C!--%20face%20--%3E%0A%3Crect%20x=%2210%22%20y=%2210%22%20width=%2212%22%20height=%229%22%20fill=%22%23f2c39a%22/%3E%0A%3Crect%20x=%2211%22%20y=%2213%22%20width=%222%22%20height=%222%22%20fill=%22%232b2b2b%22/%3E%3Crect%20x=%2219%22%20y=%2213%22%20width=%222%22%20height=%222%22%20fill=%22%232b2b2b%22/%3E%0A%3Crect%20x=%2213%22%20y=%2217%22%20width=%226%22%20height=%221%22%20fill=%22%23c98a63%22/%3E%0A%3C!--%20dress%20--%3E%0A%3Crect%20x=%229%22%20y=%2219%22%20width=%2214%22%20height=%227%22%20fill=%22%23ff7aa8%22/%3E%0A%3Crect%20x=%226%22%20y=%2220%22%20width=%223%22%20height=%225%22%20fill=%22%23f2c39a%22/%3E%3Crect%20x=%2223%22%20y=%2220%22%20width=%223%22%20height=%225%22%20fill=%22%23f2c39a%22/%3E%0A%3C!--%20legs%20--%3E%0A%3Crect%20x=%2210%22%20y=%2226%22%20width=%225%22%20height=%223%22%20fill=%22%233b3b3b%22/%3E%3Crect%20x=%2217%22%20y=%2226%22%20width=%225%22%20height=%223%22%20fill=%22%233b3b3b%22/%3E%0A%3Crect%20x=%229%22%20y=%2229%22%20width=%227%22%20height=%222%22%20fill=%22%23111%22/%3E%3Crect%20x=%2216%22%20y=%2229%22%20width=%227%22%20height=%222%22%20fill=%22%23111%22/%3E%0A%3C/svg%3E";

    const qEl = document.getElementById("q");
    const listEl = document.getElementById("list");
    const emptyEl = document.getElementById("empty");
    const statusEl = document.getElementById("status");

    function setStatus(txt) {
      if (!txt) { statusEl.style.display = "none"; statusEl.textContent = ""; return; }
      statusEl.style.display = "inline-block";
      statusEl.textContent = txt;
    }

    // For now, public pages use the usernames doc only (works with your current Firestore rules).
    // If later you store avatar/gender publicly, update this to choose FEMALE vs MALE.
    function avatarForPublic(unameDocData) {
      const g = (unameDocData && unameDocData.gender) ? String(unameDocData.gender).toLowerCase() : "";
      if (g === "female") return FEMALE;
      return MALE;
    }

    function toDateSafe(ts) {
      try {
        if (ts && typeof ts.toDate === "function") return ts.toDate();
      } catch {}
      return null;
    }

    function cardHtml(username, unameData) {
      const av = avatarForPublic(unameData);
      const joined = toDateSafe(unameData?.createdAt);
      const joinedTxt = joined ? joined.toLocaleDateString() : "—";
      const prettyUrl = `USER/1/${encodeURIComponent(username)}`;

      return `
        <div class="userCard">
          <img class="avatarSmall" alt="Avatar" src="${av}">
          <div class="userMeta">
            <div class="name"><a href="${prettyUrl}">${username}</a></div>
            <div class="sub">Joined: <b>${joinedTxt}</b></div>
            <div class="sub">Profile: <span class="mono">/USER/1/${username}</span></div>
          </div>
        </div>
      `;
    }

    async function searchUsers(prefixRaw) {
      const prefix = (prefixRaw || "").trim().toLowerCase();
      listEl.innerHTML = "";
      emptyEl.style.display = "none";

      if (!prefix) {
        emptyEl.style.display = "block";
        setStatus("");
        return;
      }

      setStatus("Searching…");

      try {
        const qq = query(
          collection(db, "usernames"),
          orderBy(documentId()),
          startAt(prefix),
          endAt(prefix + "\uf8ff"),
          limit(25)
        );

        const snaps = await getDocs(qq);
        const hits = [];
        snaps.forEach((d) => hits.push({ uname: d.id, data: d.data() }));

        if (!hits.length) {
          listEl.innerHTML = `<div class="muted">No users found for <b>${prefixRaw}</b>.</div>`;
          setStatus("0 results");
          return;
        }

        listEl.innerHTML = hits.map(h => cardHtml(h.uname, h.data)).join("");
        setStatus(`${hits.length} result${hits.length === 1 ? "" : "s"}`);
      } catch (e) {
        console.error(e);
        listEl.innerHTML = `<div class="muted">Search failed. Check Firebase config + Firestore rules.</div>`;
        setStatus("Error");
      }
    }

    document.getElementById("btnUsers").addEventListener("click", () => searchUsers(qEl.value));
    qEl.addEventListener("keydown", (e) => { if (e.key === "Enter") searchUsers(qEl.value); });

    const params = new URLSearchParams(location.search);
    if (params.get("q")) {
      qEl.value = params.get("q");
      searchUsers(qEl.value);
    }
  </script></script>
</body>
</html>
